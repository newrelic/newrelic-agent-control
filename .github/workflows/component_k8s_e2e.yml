name: ðŸ“ž k8s E2E tests

on:
  workflow_call:
    inputs:
      scenarios:
        description: 'JSON array of test scenarios to run'
        required: false
        type: string
        default: '[]'
      minikube_start_args:
        description: 'Arguments to pass to Minikube start command'
        required: false
        type: string
        default: ''
      use_latest_flux:
        description: 'enables using the latest flux chart'
        required: false
        type: boolean
        default: false
    secrets:
      NR_SYSTEM_IDENTITY_CLIENT_ID:
        required: false
      NR_SYSTEM_IDENTITY_PRIVATE_KEY:
        required: false
      E2E_ACCOUNT_ID:
        required: true
      E2E_API_KEY:
        required: true
      E2E_LICENSE_KEY:
        required: true

permissions:
  contents: read

jobs:
  # These tests are using (by default) the released charts
  # In case a breaking change is introduced by the PR, a feature branch can be used as explained
  # in the test/k8s-e2e/Readme.md
  k8s-e2e-tests:
    name: K8s e2e tests ${{ matrix.group }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group: ${{ fromJSON(inputs.scenarios) }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      
      - name: Free up space
        run: bash .github/workflows/scripts/space_cleanup.sh

      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@b589f2d61bf96695c546929c72b38563e856059d # v2.14.0
        with:
          minikube version: v1.35.0
          kubernetes version: "v1.30.14"
          start args: ${{ inputs.minikube_start_args }}
          driver: docker
          github token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tilt
        run: |
          curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash

      - uses: ./.github/actions/install-rust-toolchain
        with:
          targets: >-
            x86_64-unknown-linux-musl

      - uses: ./.github/actions/rust-cache
        with:
          identifier: 'test-dev'
          restore-strategy: 'nearest'
          save-cache: false

      - name: Install Zig
        uses: mlugg/setup-zig@d1434d08867e3ee9daa34448df10607b98908d29 # v2

      - uses: taiki-e/install-action@650c5ca14212efbbf3e580844b04bdccf68dac31 # v2.67.18
        with:
          tool: cargo-zigbuild@0.20.1

      - name: Run k8s e2e-test ${{ matrix.group }}
        uses: newrelic/newrelic-integration-e2e-action@c548a33a0c2941a4db4899ded766923eb3178e0e # v1
        env:
          # SI L2->L2 for AC
          NR_SYSTEM_IDENTITY_CLIENT_ID: ${{ secrets.NR_SYSTEM_IDENTITY_CLIENT_ID }}
          NR_SYSTEM_IDENTITY_PRIVATE_KEY: ${{ secrets.NR_SYSTEM_IDENTITY_PRIVATE_KEY }}
          USE_LATEST_FLUX: ${{ inputs.use_latest_flux }}
          # Tilt configs
          ARCH: amd64
        with:
          retry_attempts: 40
          retry_seconds: 15
          agent_enabled: false
          spec_path: test/k8s-e2e/${{ matrix.group }}/e2e-${{ matrix.group }}.yml
          account_id: ${{ secrets.E2E_ACCOUNT_ID }}
          api_key: ${{ secrets.E2E_API_KEY }}
          license_key: ${{ secrets.E2E_LICENSE_KEY }}

  k8s-e2e-tests-check: # The job is useful to notify the failure
    name: K8s e2e tests
    if: always() # cannot be skipped even if required steps fail
    runs-on: ubuntu-latest
    needs: [ k8s-e2e-tests ]
    steps:
      - name: Check if needed jobs succeeded
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # 05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
        with:
          jobs: ${{ toJSON(needs) }}
