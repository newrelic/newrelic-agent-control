name: üìû k8s E2E tests (Larger Runner)

on:
  workflow_dispatch:
    inputs:
      scenarios:
        description: "JSON array of test scenarios to run"
        required: false
        type: string
        default: '["fleet-control-staging"]'
      minikube_start_args:
        description: "Arguments to pass to Minikube start command"
        required: false
        type: string
        default: ""
      use_latest_flux:
        description: "enables using the latest flux chart"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  k8s-e2e-tests:
    name: K8s e2e tests ${{ matrix.group }}
    runs-on: linux-4-core-nr-control
    strategy:
      matrix:
        group: ${{ fromJSON(inputs.scenarios) }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Free up space
        run: bash .github/workflows/scripts/space_cleanup.sh

      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@b589f2d61bf96695c546929c72b38563e856059d # v2.14.0
        with:
          minikube version: v1.35.0
          kubernetes version: "v1.30.14"
          start args: ${{ inputs.minikube_start_args }}
          driver: docker
          github token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tilt
        run: |
          curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash

      - uses: ./.github/actions/install-rust-toolchain
        with:
          targets: >-
            x86_64-unknown-linux-musl

      - uses: ./.github/actions/rust-cache
        with:
          identifier: "test-dev"
          restore-strategy: "nearest"
          save-cache: false

      - name: Install Zig
        uses: mlugg/setup-zig@e7d1537c378b83b8049f65dda471d87a2f7b2df2 # v2

      - uses: taiki-e/install-action@542cebaaed782771e619bd5609d97659d109c492 # v2.66.7
        with:
          tool: cargo-zigbuild@0.20.1

      - id: get-token
        run: |
          echo "${{ secrets.AC_FC_STAG_E2E_NR_SYSTEM_IDENTITY_PRIVATE_KEY }}" > /tmp/cred.pem

          docker run -v /tmp/cred.pem:/private-key.pem:ro \
            newrelic/agent-control-system-identity-registration:latest authenticate \
            --client-id c292e78c-d09f-4db5-a4d1-1103dbe43846 \
            --environment STAGING \
            --private-key-path /private-key.pem \
            --output-token-format PLAIN
            > /tmp/agent-control-token.txt

          TOKEN=$(cat /tmp/agent-control-token.txt)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

          rm /tmp/cred.pem
          rm /tmp/agent-control-token.txt

      # This would be replaced with the actual E2E test that requires the larger runner.
      # It would "Install AC" and leave it running while we drive the staging endpoints.
      - name: Run k8s e2e-test ${{ matrix.group }}
        id: e2e_test
        uses: newrelic/newrelic-integration-e2e-action@c548a33a0c2941a4db4899ded766923eb3178e0e # v1
        env:
          # SI L2->L2 for AC
          NR_SYSTEM_IDENTITY_CLIENT_ID: ${{ secrets.AC_FC_STAG_E2E_NR_SYSTEM_IDENTITY_CLIENT_ID }}
          NR_SYSTEM_IDENTITY_PRIVATE_KEY: ${{ secrets.AC_FC_STAG_E2E_NR_SYSTEM_IDENTITY_PRIVATE_KEY }}
          USE_LATEST_FLUX: ${{ inputs.use_latest_flux }}
          # Tilt configs
          ARCH: amd64
        with:
          retry_attempts: 40
          retry_seconds: 15
          agent_enabled: false
          spec_path: test/k8s-e2e/${{ matrix.group }}/e2e-${{ matrix.group }}.yml
          account_id: ${{ secrets.AC_FC_STAG_E2E_ACCOUNT_ID }}
          api_key: ${{ secrets.AC_FC_STAG_E2E_API_KEY }}
          license_key: ${{ secrets.AC_FC_STAG_E2E_LICENSE_KEY }}

      - name: Trigger FC test (fixed fleet id for now)
        id: trigger-fc-test
        shell: bash
        run: |
          MAX_RETRIES=5
          URL="https://fleet-management-e2e-test-runner.staging-service.newrelic.com/test-runner/trigger-suites"
          TOKEN="${{ steps.get-token.outputs.token }}"

          for ((i=1; i<=MAX_RETRIES; i++)); do
            HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST "$URL" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d '{
                "includeTestTags": ["DEPLOYMENT_SERVICES"],
                "excludeTestTags": [],
                "includeParameterTags": [],
                "excludeParameterTags": [],
                "debugRun": false,
                "allowHiddenTests": false
              }')

            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "‚úÖ Success: Triggered test suite (HTTP 200)"
              cat response.json
              TEST_RUN_ID=$(cat response.json | jq -r '.testRunId')
              echo "Test Run ID: $TEST_RUN_ID"
              echo "test_run_id=$TEST_RUN_ID" >> "$GITHUB_OUTPUT"
              exit 0
            elif [ "$HTTP_CODE" -eq 404 ]; then
              echo "‚ö†Ô∏è  Attempt $i/$MAX_RETRIES: Received 404 Not Found. Retrying in 10s..."
              sleep 10
            else
              echo "‚ùå Failed with HTTP $HTTP_CODE"
              cat response.json
              exit 1
            fi
          done

          echo "‚ùå Timed out waiting for 200 OK after $MAX_RETRIES attempts."
          exit 1

      - name: Wait for FC test completion
        id: wait-for-fc-completion
        shell: bash
        run: |
          TEST_RUN_ID="${{ steps.trigger-fc-test.outputs.test_run_id }}"
          TOKEN="${{ steps.get-token.outputs.token }}"
          URL_BASE="https://fleet-management-e2e-test-runner.staging-service.newrelic.com/test-runner/status"

          # Timeout in seconds (10 minutes)
          TIMEOUT=600
          START_TIME=$(date +%s)

          echo "Waiting for test run $TEST_RUN_ID to complete (Timeout: ${TIMEOUT}s)..."

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
              echo "‚ùå Timeout reached after ${ELAPSED}s waiting for tests to complete."
              exit 1
            fi

            HTTP_CODE=$(curl -s -o status_response.json -w "%{http_code}" -X GET "$URL_BASE/$TEST_RUN_ID" \
              -H "Authorization: Bearer $TOKEN")

            case "$HTTP_CODE" in
              404)
                echo "‚è≥ [$ELAPSED s] Run not found / initializing (404). Retrying..."
                sleep 5
                ;;
              204)
                echo "üèÉ [$ELAPSED s] Tests are running (204). Retrying..."
                sleep 10
                ;;
              200)
                echo "‚úÖ [$ELAPSED s] Tests completed successfully (200)!"
                cat status_response.json | jq .
                exit 0
                ;;
              450)
                echo "‚ùå [$ELAPSED s] Tests failed (450)."
                cat status_response.json | jq .
                exit 1
                ;;
              *)
                echo "‚ùå [$ELAPSED s] Unexpected status code: $HTTP_CODE"
                cat status_response.json
                exit 1
                ;;
            esac
          done

      - name: Dump logs, stop Tilt on failure
        if: always()
        run: |
          kubectl logs --tail=-1 -l app.kubernetes.io/name=agent-control --all-containers --prefix=true
          kubectl logs --tail=-1 -l app.kubernetes.io/instance=nr-infra --all-containers --prefix=true -n newrelic-agents
          kubectl get secrets --show-labels
          kubectl get configmap
          kubectl get all -o wide --all-namespaces --show-labels
          kubectl get helmrelease
          kubectl get helmchart
          helm list -a -A
          tilt down

  k8s-e2e-tests-check: # The job is useful to notify the failure
    name: K8s e2e tests
    if: always() # cannot be skipped even if required steps fail
    runs-on: ubuntu-latest
    needs: [k8s-e2e-tests]
    steps:
      - name: Check if needed jobs succeeded
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # 05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
        with:
          jobs: ${{ toJSON(needs) }}
