name: ðŸ“ž Staging reachability tests (Larger Runner)

on:
  pull_request:

permissions:
  contents: read

jobs:
  reach-staging:
    name: Reach staging URLs on larger runner (${{ matrix.name }})
    runs-on: linux-4-core-nr-control
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Public keys"
            url: "https://staging-publickeys.newrelic.com/r/blob-management/global/agentconfiguration/jwks.json"
          - name: "System Identity OAuth"
            url: "https://system-identity-oauth.staging-service.newrelic.com/oauth2/token"
          - name: "OpAMP"
            url: "https://opamp.staging-service.newrelic.com/v1/opamp"
          - name: "Test Runner VIP"
            url: "https://fleet-management-e2e-test-runner.vip.cf.nr-ops.net"
          - name: "Test Runner VIP tags (IngDom)"
            url: "https://fleet-management-e2e-test-runner.staging-service.newrelic.com/test-runner/tags"
          - name: "Test Runner VIP check (IngDom)"
            url: "https://fleet-management-e2e-test-runner.staging-service.newrelic.com/status/check"
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install xh
        run: |
          nix profile add nixpkgs#xh

      - name: Print the IP of this machine
        run: xh get https://api.ipify.org?format=json

      - id: get-token
        run: |
          echo "${{ secrets.AC_FC_STAG_E2E_NR_SYSTEM_IDENTITY_PRIVATE_KEY }}" > /tmp/cred.pem

          docker run -v /tmp/cred.pem:/private-key.pem:ro \
            newrelic/agent-control-system-identity-registration:latest authenticate \
            --client-id c292e78c-d09f-4db5-a4d1-1103dbe43846 \
            --environment STAGING \
            --private-key-path /private-key.pem \
            --output-token-format PLAIN \
            > /tmp/agent-control-token.txt

          TOKEN=$(cat /tmp/agent-control-token.txt)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

          rm /tmp/cred.pem
          rm /tmp/agent-control-token.txt

      - name: "Attempt to reach staging URLs: ${{ matrix.name }}"
        run: xh get ${{ matrix.url }} --all --pretty all -A bearer -a "${{ steps.get-token.outputs.token }}"
