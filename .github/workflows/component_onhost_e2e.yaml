name: ðŸ“ž OnHost E2E tests

on:
  workflow_call:
    secrets:
      NR_SYSTEM_IDENTITY_CLIENT_ID:
        required: false
      NR_SYSTEM_IDENTITY_PRIVATE_KEY:
        required: false
      E2E_ACCOUNT_ID:
        required: true
      E2E_API_KEY:
        required: true
      E2E_LICENSE_KEY:
        required: true

    inputs:
      scenarios:
        description: "JSON array of test scenarios to run"
        required: false
        type: string
        default: '["remote-config", "ebpf-agent", "infra-agent", "nrdot-agent", "proxy"]'

permissions:
  contents: read

# NOTE: The below environment vars are bumped automatically by Renovate so we always use the latest
# versions of the packages in our E2E tests. If you change the names or move these values outside
# the GitHub workflows please update `renovate.json` accordingly to avoid breaking the automation!
env:
  HOST_E2E_INFRA_AGENT_VERSION: "1.72.1"
  HOST_E2E_NRDOT_VERSION: "1.8.0"

jobs:
  build-packages:
    name: Build packages
    uses: ./.github/workflows/component_packages.yml
    with:
      pre-release: false
      skip_sign: true
      tag_name: 0.900.${{ github.run_id }}

  on-host-linux-e2e:
    name: OnHost Linux E2E tests
    needs: [ build-packages ]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        group: ${{ fromJSON(inputs.scenarios) }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./.github/actions/install-rust-toolchain
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: built-binaries-0.900.${{ github.run_id }}
          path: ./
      - name: Build e2e-runner binary
        run: cargo build -p e2e-runner
      - name: "Linux e2e ${{ matrix.group }}"
        run: |
          echo "${{ secrets.NR_SYSTEM_IDENTITY_PRIVATE_KEY }}" > /tmp/newrelic-agent-control-priv.key
          sudo ${{ github.workspace }}/target/debug/e2e-runner --log-level=debug ${{ matrix.group }} \
            --artifacts-package-dir ./dist \
            --nr-api-key "${{ secrets.E2E_API_KEY }}" \
            --nr-license-key "${{ secrets.E2E_LICENSE_KEY }}" \
            --nr-account-id "${{ secrets.E2E_ACCOUNT_ID }}" \
            --nr-region "us" \
            --system-identity-client-id "${{ secrets.NR_SYSTEM_IDENTITY_CLIENT_ID }}" \
            --agent-control-private-key "/tmp/newrelic-agent-control-priv.key" \
            --agent-control-version "0.900.${{ github.run_id }}" \
            --recipes-repo-branch "feat/removeAgents" \
            --nrdot-version "${{ env.HOST_E2E_NRDOT_VERSION }}"

  on-host-windows-e2e:
    name: OnHost Windows E2E tests
    needs: [ build-packages ]
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        group: [ infra-agent, nrdot, proxy, wrong-config ]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: ./.github/actions/install-rust-toolchain
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: built-binaries-0.900.${{ github.run_id }}
          path: ./
      - name: Build e2e-runner binary
        run: cargo build -p e2e-runner
      - name: "Windows e2e ${{ matrix.group }}"
        shell: powershell
        run: |
          "${{ secrets.NR_SYSTEM_IDENTITY_PRIVATE_KEY }}" | Out-File -Encoding utf8 -FilePath $env:TEMP\newrelic-agent-control-priv.key
          & "${{ github.workspace }}\target\debug\e2e-runner.exe" --log-level=debug ${{ matrix.group }} `
            --artifacts-package-dir .\dist `
            --nr-api-key "${{ secrets.E2E_API_KEY }}" `
            --nr-license-key "${{ secrets.E2E_LICENSE_KEY }}" `
            --nr-account-id "${{ secrets.E2E_ACCOUNT_ID }}" `
            --nr-region "us" `
            --system-identity-client-id "${{ secrets.NR_SYSTEM_IDENTITY_CLIENT_ID }}" `
            --agent-control-private-key "$env:TEMP\newrelic-agent-control-priv.key" `
            --agent-control-version "0.900.${{ github.run_id }}" `
            --recipes-repo-branch "feat/removeAgents" `
            --infra-agent-version "${{ env.HOST_E2E_INFRA_AGENT_VERSION }}" `
            --nrdot-version "${{ env.HOST_E2E_NRDOT_VERSION }}"
