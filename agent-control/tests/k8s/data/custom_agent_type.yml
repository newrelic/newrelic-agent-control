namespace: newrelic
name: com.newrelic.custom_agent
version: 0.0.1
variables:
  k8s:
    chart_values:
      description: "chart_values"
      type: yaml
      required: false
      default: { }
deployment:
  k8s:
    health:
      interval: 5s
      initial_delay: 2s
    objects:
      repository:
        apiVersion: source.toolkit.fluxcd.io/v1
        kind: HelmRepository
        metadata:
          name: ${nr-sub:agent_id}
          namespace: ${nr-ac:namespace}
        spec:
          # we don't want to trigger this in the test to avoid extra load in the cluster
          interval: 99m
          url: https://helm.github.io/examples
      release:
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: ${nr-sub:agent_id}
          namespace: ${nr-ac:namespace}
        spec:
          # we don't want to trigger this in the test to avoid extra load in the cluster
          interval: 10s
          releaseName: ${nr-sub:agent_id}
          targetNamespace: ${nr-ac:namespace_agents}
          chart:
            spec:
              chart: hello-world
              version: 0.1.0
              sourceRef:
                kind: HelmRepository
                name: ${nr-sub:agent_id}
                namespace: ${nr-ac:namespace}
          install:
            disableWait: true
            disableWaitForJobs: true
            disableTakeOwnership: true
            replace: true
            # namespaces lifecycle is handled by the test.
            # createNamespace: true
          upgrade:
            disableWait: true
            disableWaitForJobs: true
            disableTakeOwnership: true 
            cleanupOnFail: true
            force: true
          values:
            ${nr-var:chart_values}
