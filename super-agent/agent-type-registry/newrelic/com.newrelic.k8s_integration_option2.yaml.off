namespace: newrelic
name: com.newrelic.k8s_integration
version: 0.1.0
variables:
  k8s:
    newrelic-infrastructure:
      description: "chart values"
      type: yaml
      required: false
      default: {}
    nri-metadata-injection:
      description: "chart values"
      type: yaml
      required: false
      default: {}
    kube-state-metrics:
      description: "chart values"
      type: yaml
      required: false
      default: {}
    nri-kube-events:
      description: "chart values"
      type: yaml
      required: false
      default: {}
    global:
      description: "global values"
      type: yaml
      required: false
      default: {}
    default_chart_values:
      description: "nri-bundle chart values"
      # New type of varialbe that will create a CM that contains the yaml values
      # insde a key with the same name as the variable
      # the ${nr-var:<var_name>} will print the name of the CM (composed by the agent_id and the variable name)
      type: yaml_config_map
      required: false
      default:
        newrelic-infrastructure:
          enabled: true
        nri-metadata-injection:
          enabled: true
        kube-state-metrics:
          enabled: true
        nri-kube-events:
          enabled: true
        global:
          licenseKey: ${nr-env:NR_LICENSE_KEY}
          cluster: ${nr-env:NR_CLUSTER_NAME}
    chart_version:
      description: "nri-bundle chart version"
      type: string
      required: false
      default: "5.0.95"
deployment:
  k8s:
    health:
      interval: 30s
    objects:
      repository: {...} # will get newrelic helm charts repo
      release:
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: ${nr-sub:agent_id}
        spec:
          chart: { ... } # will install nri-bundle

          valuesFrom:
          - kind: ConfigMap
            name: ${nr-var:default_chart_values}
            valuesKey: default_chart_values
          values:
            newrelic-infrastructure: ${nr-var:newrelic-infrastructure}
            nri-metadata-injection: ${nr-var:nri-metadata-injection}
            kube-state-metrics: ${nr-var:kube-state-metrics}
            nri-kube-events: ${nr-var:nri-kube-events}
            global: ${nr-var:global}

            nri-prometheus:
              enabled: false
            ... # disable all other sub-charts
