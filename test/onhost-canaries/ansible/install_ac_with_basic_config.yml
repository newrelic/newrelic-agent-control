---

- name: Install Agent Control and add basic configuration (Infra Agent)
  hosts: testing_hosts_linux
  become: true
  gather_facts: no

  vars:
    # Pre-release version of the agent control is used by default
    repo_endpoint: http://nr-downloads-ohai-staging.s3-website-us-east-1.amazonaws.com/preview
    agent_control_private_key: /etc/newrelic-agent-control/priv.key
    infra_staging: true

  tasks:

  - name: Wait for host connection
    ansible.builtin.wait_for_connection:
      delay: 10
      timeout: 300

  - name: Gather facts
    setup:

  - name: Configure hostname
    include_role:
      name: caos.ansible_roles.hostname

  - name: Install Agent Control
    vars:
      repo_endpoint: "{{ repo_endpoint }}"
      package_version: "{{ package_version }}"
    include_role:
      name: newrelic-agent-control

  - name: Register agent control version
    command: "/usr/bin/newrelic-agent-control --version"
    register: version

  - name: Debug agent control version
    debug:
      var: version.stdout

  - name: Import the L2 private key from env-var
    copy:
      dest: "{{ agent_control_private_key }}"
      # Read private key from an env var directly because of issues passing multiline --extra-vars to ansible-playbook.
      content: "{{ lookup('ansible.builtin.env', 'NR_SYSTEM_IDENTITY_PRIVATE_KEY') }}"

  - name: Setup AC config
    include_role:
      name: edit_yaml_config
    vars:
      config_path: "/etc/newrelic-agent-control/local-data/agent-control/local_config.yaml"
      update_config:
        fleet_control:
          auth_config:
            client_id: "{{ system_identity_client_id }}"
            private_key_path: "{{ agent_control_private_key }}"
            provider: local
            token_url: "{{ token_endpoint }}"
          endpoint: "{{ opamp_endpoint }}"
          fleet_id: "{{ fleet_id }}"
          signature_validation:
            public_key_server_url: "{{ signature_validation_endpoint }}"
        log:
          level: debug
        self_instrumentation:
          opentelemetry:
            endpoint: "{{ otlp_endpoint }}"
            headers:
              api-key: "{{ nr_license_key }}"
            traces:
              enabled: true
            logs:
              enabled: true
        agents:
          infra:
            agent_type: "newrelic/com.newrelic.infrastructure:0.1.0"

  - name: Infra Agent config folder
    file:
      path: /etc/newrelic-agent-control/local-data/infra/
      state: directory

  - name: Infra Agent config file
    copy:
      dest: /etc/newrelic-agent-control/local-data/infra/local_config.yaml
      content: |
        {% raw %}
        config_agent:
          staging: {% endraw -%} {{ infra_staging }} {%- raw %}
          enable_process_metrics: true
          status_server_enabled: true
          status_server_port: 18003
          license_key: '{{NEW_RELIC_LICENSE_KEY}}'
        {% endraw %}

  - name: Env file
    copy:
      dest: /etc/newrelic-agent-control/environment_variables.yaml
      content: |
        NEW_RELIC_LICENSE_KEY: "{{ nr_license_key }}"

  - name: Restart Agent Control
    include_role:
      name: caos.ansible_roles.service_status
    vars:
      service_name: "newrelic-agent-control"
      action: "restart"

  - name: Wait for Infra Agent to start
    pause:
      seconds: 30

  - name: Assert Agent Control and Infra Agent are running
    include_role:
      name: caos.ansible_roles.assert_process_running
    vars:
      processes_running:
        - "^/usr/bin/newrelic-agent-control"
        - "^/usr/bin/newrelic-infra"

- name: installation-windows
  hosts: testing_hosts_windows
  gather_facts: yes

  vars:
    # Pre-release version of the agent control is used by default
    repo_endpoint: http://nr-downloads-ohai-staging.s3-website-us-east-1.amazonaws.com/preview
    extract_dest: "C:\\temp\\newrelic-agent-control"
    agent_control_private_key: "C:\\temp\\newrelic-agent-control\\priv.key"
    infra_staging: true

  tasks:
    - name: Gather facts
      setup:

    - name: Configure hostname
      include_role:
        name: caos.ansible_roles.hostname

#    At the moment there is no publishing of the last infra-agent package to a public repository, and we use the Github
#    package repository that can't be on constant sync with the latest infra-agent version.
#    We may use this commented code to gather the latest infra-agent version once Fleet creates an infra-agent oci repo
#    and the agent-type points to it.
#
#    - name: Get Infra Agent release info from GitHub API
#      ansible.windows.win_uri:
#        url: https://api.github.com/repos/newrelic/infrastructure-agent/releases/latest
#        method: GET
#        return_content: yes
#      register: github_api_response
#
#    - name: Extract version from API response
#      ansible.builtin.set_fact:
#        infra_version: "v{{ github_api_response.json.tag_name }}"

    - name: Set infra version matching an existing one in the Github oci package repo
      ansible.builtin.set_fact:
        infra_version: "v1.71.4"

    - name: Display the infra-agent version
      ansible.builtin.debug:
        msg: "The latest infra-agent version is {{ infra_version }}"

    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Download Agent Control zip
      ansible.windows.win_get_url:
        url: "{{ repo_endpoint }}/binaries/windows/amd64/newrelic-agent-control_{{ package_version }}_windows_amd64.zip"
        dest: "C:\\temp\\newrelic-agent-control_{{ package_version }}_windows_amd64.zip"
        force: yes

    - name: Extract Agent Control zip
      ansible.windows.win_powershell:
        script: |
          $zipPath = "C:\temp\newrelic-agent-control_{{ package_version }}_windows_amd64.zip"
          $extractPath = "{{ extract_dest }}"

          if (Test-Path $extractPath) {
            Remove-Item -Path $extractPath -Recurse -Force
          }

          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

    - name: Import the L2 private key from env-var
      copy:
        dest: "{{ agent_control_private_key }}"
        # Read private key from an env var directly because of issues passing multiline --extra-vars to ansible-playbook.
        content: "{{ lookup('ansible.builtin.env', 'NR_SYSTEM_IDENTITY_PRIVATE_KEY') }}"

    - name: Execute New Relic Agent Control install script
      ansible.windows.win_powershell:
        chdir: "{{ extract_dest }}"
        script: |
          $cliArgs = @{
              LicenseKey          = "{{ nr_license_key }}"
              Region              = "{{ 'Staging' if infra_staging | bool else 'us' }}"
              ServiceOverwrite    = $true
              FleetEnabled        = $true
              FleetId             = "{{ fleet_id }}"
              AuthClientId        = "{{ system_identity_client_id }}"
              AuthPrivateKeyPath  = "{{ agent_control_private_key }}"
          }
          
          & .\install.ps1 @cliArgs
      register: install_result
      failed_when:
        - install_result.exit_code is defined
        - install_result.exit_code != 0
        - install_result.exit_code != 133

    - name: Register agent control version
      ansible.windows.win_command: '"C:\Program Files\New Relic\newrelic-agent-control\newrelic-agent-control.exe" --version'
      register: version

    - name: Debug agent control version
      debug:
        var: version.stdout

    - name: Update agents configuration in local_config.yaml
      ansible.windows.win_powershell:
        script: |
          $configPath = "C:\Program Files\New Relic\newrelic-agent-control\local-data\agent-control\local_config.yaml"
          $content = Get-Content $configPath -Raw
          
          $oldAgents = "agents: {}"
          $newAgents = @"
          agents:
            nr-infra:
              agent_type: "newrelic/com.newrelic.infrastructure:0.1.0"
          "@
          
          $newContent = $content -replace [regex]::Escape($oldAgents), $newAgents
          [IO.File]::WriteAllText($configPath, $newContent)

    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: "C:\\Program Files\\New Relic\\newrelic-agent-control\\local-data\\nr-infra"
        state: directory

    - name: Infra Agent config file
      copy:
        dest: "C:\\Program Files\\New Relic\\newrelic-agent-control\\local-data\\nr-infra\\local_config.yaml"
        content: |
          {% raw %}
          config_agent:
            staging: {% endraw -%} {{ infra_staging }} {%- raw %}
            enable_process_metrics: true
            status_server_enabled: true
            status_server_port: 18003
            license_key: '{{NEW_RELIC_LICENSE_KEY}}'
          version: {% endraw -%} {{ infra_version }} {%- raw %}
          {% endraw %}

    - name: Restart New Relic Agent Control service
      ansible.windows.win_service:
        name: newrelic-agent-control
        state: restarted
