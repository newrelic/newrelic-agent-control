---

- name: Install Agent Control and add basic configuration (Infra Agent)
  hosts: testing_hosts_linux
  become: true
  gather_facts: no

  vars:
    # Pre-release version of the agent control is used by default
    repo_endpoint: http://nr-downloads-ohai-staging.s3-website-us-east-1.amazonaws.com/preview
    agent_control_service_conf: /etc/newrelic-agent-control/systemd-env.conf
    agent_control_private_key: /etc/newrelic-agent-control/priv.key
    infra_staging: true

  tasks:

  - name: Wait for host connection
    ansible.builtin.wait_for_connection:
      delay: 10
      timeout: 300

  - name: Gather facts
    setup:

  - name: Configure hostname
    include_role:
      name: caos.ansible_roles.hostname

  - name: Install Agent Control
    vars:
      repo_endpoint: "{{ repo_endpoint }}"
      package_version: "{{ package_version }}"
    include_role:
      name: newrelic-agent-control

  - name: Register agent control version
    command: "/usr/bin/newrelic-agent-control --version"
    register: version

  - name: Debug agent control version
    debug:
      var: version.stdout

  - name: Import the L2 private key from env-var
    copy:
      dest: "{{ agent_control_private_key }}"
      # Read private key from an env var directly because of issues passing multiline --extra-vars to ansible-playbook.
      content: "{{ lookup('ansible.builtin.env', 'NR_SYSTEM_IDENTITY_PRIVATE_KEY') }}"

  - name: Setup AC config
    include_role:
      name: edit_yaml_config
    vars:
      config_path: "/etc/newrelic-agent-control/local-data/agent-control/local_config.yaml"
      update_config:
        fleet_control:
          auth_config:
            client_id: "{{ system_identity_client_id }}"
            private_key_path: "{{ agent_control_private_key }}"
            provider: local
            token_url: "{{ token_endpoint }}"
          endpoint: "{{ opamp_endpoint }}"
          fleet_id: "{{ fleet_id }}"
          signature_validation:
            public_key_server_url: "{{ signature_validation_endpoint }}"
        log:
          level: debug
        self_instrumentation:
          opentelemetry:
            endpoint: "{{ otlp_endpoint }}"
            headers:
              api-key: "{{ nr_license_key }}"
            traces:
              enabled: true
            logs:
              enabled: true
        agents:
          infra:
            agent_type: "newrelic/com.newrelic.infrastructure:0.1.0"

  - name: Infra Agent config folder
    file:
      path: /etc/newrelic-agent-control/local-data/infra/
      state: directory

  - name: Infra Agent config file
    copy:
      dest: /etc/newrelic-agent-control/local-data/infra/local_config.yaml
      content: |
        {% raw %}
        config_agent:
          staging: {% endraw -%} {{ infra_staging }} {%- raw %}
          enable_process_metrics: true
          status_server_enabled: true
          status_server_port: 18003
          license_key: '{{NEW_RELIC_LICENSE_KEY}}'
        {% endraw %}

  - name: Add license to service
    shell: echo 'NEW_RELIC_LICENSE_KEY="{{ nr_license_key }}"' > {{ agent_control_service_conf }}

  - name: Restart Agent Control
    include_role:
      name: caos.ansible_roles.service_status
    vars:
      service_name: "newrelic-agent-control"
      action: "restart"

  - name: Wait for Infra Agent to start
    pause:
      seconds: 30

  - name: Assert Agent Control and Infra Agent are running
    include_role:
      name: caos.ansible_roles.assert_process_running
    vars:
      processes_running:
        - "^/usr/bin/newrelic-agent-control"
        - "^/usr/bin/newrelic-infra"

- name: installation-windows
  hosts: testing_hosts_windows
  gather_facts: yes

  vars:
    # Pre-release version of the agent control is used by default
    repo_endpoint: http://nr-downloads-ohai-staging.s3-website-us-east-1.amazonaws.com/preview
    extract_dest: "C:\\temp\\newrelic-agent-control"

  tasks:
    - name: Ensure temp directory exists
      ansible.windows.win_file:
        path: C:\temp
        state: directory

    - name: Download Agent Control zip
      ansible.windows.win_get_url:
        url: "{{ repo_endpoint }}/binaries/windows/amd64/newrelic-agent-control_{{ package_version }}_windows_amd64.zip"
        dest: "C:\\temp\\newrelic-agent-control_0.100.19917356190_windows_amd64.zip"
        force: yes

    - name: Extract Agent Control zip
      ansible.windows.win_powershell:
        script: |
          $zipPath = "C:\temp\newrelic-agent-control_{{ package_version }}_windows_amd64.zip"
          $extractPath = "{{ extract_dest }}"

          if (Test-Path $extractPath) {
            Remove-Item -Path $extractPath -Recurse -Force
          }

          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

    - name: Execute install.ps1
      ansible.windows.win_powershell:
        chdir: "{{ extract_dest }}"
        script: |
          .\install.ps1

    - name: Wait for Agent Control to start
      pause:
        seconds: 30

    - name: Check if agent-control is running
      ansible.windows.win_powershell:
        script: |
          $status = Invoke-RestMethod -Uri http://localhost:51200/status -Method Get
          $pattern = 'agent_control":{"healthy":(\w+)'
          $isHealthy = $status.agent_control.healthy
          $match = $isHealthy | Select-String -Pattern $pattern
          if ($match) {
            $healthyStatus = $match.Matches.Groups[1].Value
            if ($healthyStatus -eq "true") {
              exit 0
            } 
          }
          exit 1
