---
- name: installation-over-infra-agent-and-collector
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes
  vars:
    process_user: "root"
    nr_infra_agent_version: "1.47.2"
    nr_otel_collector_version: "0.4.0"
    nr_super_agent_repo: "http://nr-downloads-ohai-staging.s3-website-us-east-1.amazonaws.com/preview"

  pre_tasks:
    - name: Update package repositories
      include_role:
        name: caos.ansible_roles.package_repo_update

    - name: Initial cleanup # Only required for shared infra.
      include_tasks: ./custom_tasks/cleanup.yml

  tasks:
    - name: Installation in a system with the Infra Agent present
      vars:

      block:
        - name: Setup NR Repo
          include_role:
            name: caos.ansible_roles.nr_repo_setup

        # Install the Infra Agent
        - name: Setup Infra Agent config
          include_role:
            name: infra-agent-config
          vars:
            nria_log_forward: true
            nria_log_level: debug
            #TODO : not sending to file is not currently working as the Infra Agent configures FB to get logs
            # from newrleic-infra systemd service and this doesn't exist with the super agent
            nria_log_file: /tmp/nr.log

        - name: install the infra agent
          include_role:
            name: caos.ansible_roles.package_install
          vars:
            package: newrelic-infra

        - name: assert Infra Agent running
          include_role:
            name: caos.ansible_roles.assert_service_status
          vars:
            services_running:
              - newrelic-infra.service

        - name: assert fluent-bit running
          include_role:
            name: caos.ansible_roles.assert_process_running
          vars:
            processes_running:
              - "^/opt/fluent-bit/bin/fluent-bit"

        - name: install docker
          include_role:
            name: caos.ansible_roles.docker_install
          vars:
            docker_compose_version: "2.15.1"

        - name: run mysql in a container to be scraped by nri-mysql
          include_tasks: ./custom_tasks/run-mysql-in-container.yaml

        - name: install nri-mysql integration
          include_role:
            name: caos.ansible_roles.nri_mysql

        # Install the NR Otel Collector
        - name: install the NR Otel Collector
          include_role:
            name: caos.ansible_roles.package_install
          vars:
            package: nr-otel-collector

        - name: Setup NR Otel Collector config
          include_role:
            name: nr-otel-collector-config

        - name: restart nr-otel-collector service
          include_role:
            name: caos.ansible_roles.service_status
          vars:
            service_name: "nr-otel-collector"
            action: "restart"

        - name: assert NR Otel Collector running
          include_role:
            name: caos.ansible_roles.assert_service_status
          vars:
            services_running:
              - nr-otel-collector.service

        - name: wait for 2 minute to allow Infra Agent and NR Otel Collector to send metrics again
          pause:
            minutes: 2

        - name:
          include_tasks: ./custom_tasks/assert-nri-mysql-sending-data.yml

        - name:
          include_tasks: ./custom_tasks/assert-fluent-bit-sending-data.yml

        - name:
          include_tasks: ./custom_tasks/assert-nr-otel-collector-sending-data.yml

        - name: install Newrelic Super Agent
          include_role:
            name: newrelic-super-agent
            apply:
              environment:
                NRDOT_MODE: "{{ 'ROOT' if (install_mode is defined and install_mode == 'ROOT') | default(omit) }}"
          vars:
            repo_endpoint: "{{ nr_super_agent_repo }}"
            target_version: "{{ nr_super_agent_version }}"

        - name: assert no service for the Infra Agent
          include_role:
            name: caos.ansible_roles.assert_no_service
          vars:
            service_name: newrelic-infra.service

        - name: assert no service for the NR Otel Collector
          include_role:
            name: caos.ansible_roles.assert_no_service
          vars:
            service_name: nr-otel-collector.service

        - name: assert versions of the installed binaries
          include_role:
            name: caos.ansible_roles.assert_version
          vars:
            target_versions:
              - exec: "newrelic-super-agent --version"
                version: "{{ nr_super_agent_version }}"
              - exec: "newrelic-infra --version"
                version: "{{ nr_infra_agent_version }}"
              - exec: "nr-otel-collector --version"
                version: "{{ nr_otel_collector_version }}"

        - name: assert that expected processes are running
          include_role:
            name: caos.ansible_roles.assert_process_running
          vars:
            processes_running:
              - "^/usr/bin/newrelic-infra "
              - "^/usr/bin/newrelic-super-agent "
              - "^/opt/fluent-bit/bin/fluent-bit "
              - "^/usr/bin/nr-otel-collector "

        - name: wait for 2 minute to give the Infra Agent and NR Otel Collector time to send metrics again
          pause:
            minutes: 2

        - name:
          include_tasks: ./custom_tasks/assert-nri-mysql-sending-data.yml

        - name:
          include_tasks: ./custom_tasks/assert-fluent-bit-sending-data.yml

        - name:
          include_tasks: ./custom_tasks/assert-nr-otel-collector-sending-data.yml

      always:
        - name: Final cleanup # Only required for shared infra.
          include_tasks: ./custom_tasks/cleanup.yml
