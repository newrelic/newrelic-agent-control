description: E2E Test

custom_test_key: k8s.cluster.name

scenarios:
  - description: Deploy SA with single k8s otel-collector
    before:
      - echo The cluster name of the test is ${SCENARIO_TAG}
      - cd ../../../ && SA_CHART_VALUES_FILE="test/k8s-e2e/collector/ac-values-collector.yml" CLUSTER=${SCENARIO_TAG} USE_LATEST_FLUX=${USE_LATEST_FLUX} tilt ci
    after:
      - kubectl logs --tail=-1 -l app.kubernetes.io/name=agent-control --all-containers --prefix=true
      - kubectl logs --tail=-1 -l app.kubernetes.io/name=nr-k8s-otel-collector --all-containers --prefix=true -n newrelic-agents
      - kubectl get all -o wide --all-namespaces --show-labels
      - kubectl get secrets --show-labels
      - kubectl get helmrelease
      - kubectl get helmchart
      - helm list -a -A
      - cd ../../../ && tilt down
    tests:
      nrqls:
        # Checks that the metric exist for the test scenario, an extra where testKey=$SCENARIO_TAG is always added.
        - query: "SELECT * from Metric where metricName = 'kube_daemonset_created' AND k8s.namespace.name='newrelic-agents'"
        - query: "SELECT * from Metric where metricName = 'k8s.pod.memory.working_set' AND k8s.namespace.name='newrelic-agents'"
