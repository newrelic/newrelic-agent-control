# Cluster and License info is set with "--set" in the e2e-spec file
installationJob:
  logLevel: debug

# Flux proxy configuration.
agent-control-cd:
  installer:
    extraEnv:
      # Configures helm repo add to use the proxy.
      - name: HTTPS_PROXY
        # we faced an issue with the proxy when using https://, so we use http://
        # https://github.com/helm/helm/issues/31111
        value: http://mitmproxy-service:8080
      # except for in-cluster request.
      - name: "NO_PROXY"
        value: ".cluster.local.,.cluster.local,cluster.local,.svc,127.0.0.0/8,10.0.0.0/8"
    extraVolumeMounts:
      # Mount a CA certificate bundle to the source-controller Trust root store.
      # It should contain the proxy CA certificates on it.
      - mountPath: /etc/ssl/certs/ca-certificates.crt
        subPath: ca-certificates.crt
        name: shared-volume-ca
    extraVolumes:
      - name: shared-volume-ca
        persistentVolumeClaim:
          claimName: mitm-ca-pvc


  flux2:
    sourceController:
      extraEnv:
        # Configures Flux source-controller to proxy all request.
        - name: HTTPS_PROXY
          value: http://mitmproxy-service:8080
        # except for in-cluster request.
        - name: "NO_PROXY"
          value: ".cluster.local.,.cluster.local,cluster.local,.svc,127.0.0.0/8,10.0.0.0/8"
      volumeMounts:
        # Mount a CA certificate bundle to the source-controller Trust root store.
        # It should contain the proxy CA certificates on it.
        - mountPath: /etc/ssl/certs/ca-certificates.crt
          subPath: ca-certificates.crt
          name: shared-volume-ca
      volumes:
        - name: shared-volume-ca
          persistentVolumeClaim:
            claimName: mitm-ca-pvc


agent-control-deployment:
  customIdentitySecretName: "sys-identity-creds"
  subAgentsNamespace: "newrelic-agents"
  # Mount a CA certificate bundle to the source-controller Trust root store.
  # It should contain the proxy CA certificates on it.
  extraVolumeMounts:
    - mountPath: /etc/ssl/certs/ca-certificates.crt
      subPath: ca-certificates.crt
      name: shared-volume-ca
  extraVolumes:
    - name: shared-volume-ca
      persistentVolumeClaim:
        claimName: mitm-ca-pvc

  proxy:
    url: https://mitmproxy-service:8080
  config:
    log:
      level: trace
    fleet_control:
      enabled: true
      # Fleet with name 'ac-e2e-empty-deployment'. The sub-agent reports data to the 'Agent Control Canaries' account.
      # This fleet doesn't have any deployment configured.
      fleet_id: NjQyNTg2NXxOR0VQfEZMRUVUfDAxOTgwOTZiLTk2NzctNzllNi05OWJmLTQ4YWRlOTRiYmZjMw
    override:
      fleet_control:
        signature_validation:
          # Disable this as is not supported by the proxy.
          # On a prod environment is recommended to add an exception for the firewall to newrelic.com or
          # mount the downloaded Certificate.
          enabled: false
    agents:
      prometheus:
        agent_type: newrelic/com.newrelic.prometheus:0.1.0
  agentsConfig:
    prometheus:
      chart_version: "*"
      # Proxy config should be added to Prom config on a prod environment. But this is out of scope of AC.
  systemIdentity:
    organizationId: b961cf81-d62b-4359-8822-7b1d6dadd374
