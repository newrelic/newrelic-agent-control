namespace: newrelic
name: com.newrelic.infrastructure
version: 0.1.0
variables:
  k8s:
    chart_values:
      newrelic-infrastructure:
        description: "newrelic-infrastructure chart values"
        type: yaml
        required: false
        default: { }
      nri-metadata-injection:
        description: "nri-metadata-injection chart values"
        type: yaml
        required: false
        default: { }
      kube-state-metrics:
        description: "kube-state-metrics chart values"
        type: yaml
        required: false
        default: { }
      nri-kube-events:
        description: "nri-kube-events chart values"
        type: yaml
        required: false
        default: { }
      global:
        description: "Global chart values"
        type: yaml
        required: false
        default: { }
    chart_version:
      description: "nri-bundle chart version"
      type: string
      required: true
    chart_location:
      description: "nri-bundle chart version"
      type: string
      required: false
      default: https://github.com/newrelic/helm-charts
deployment:
  k8s:
    health:
      interval: 30s
    objects:
      repository:
        apiVersion: source.toolkit.fluxcd.io/v1
        kind: GitRepository
        metadata:
          name: ${nr-sub:agent_id}
          namespace: ${nr-ac:namespace}
        spec:
          interval: 5m0s
          url: ${nr-var:chart_location}
          ref:
            branch: master
      values:
        apiVersion: v1
        kind: Secret
        metadata:
          name: values-${nr-sub:agent_id}
          namespace: ${nr-ac:namespace}
        stringData:
          default.yaml: |
            newrelic-infrastructure:
              enabled: true
            nri-metadata-injection:
              enabled: true
            kube-state-metrics:
              enabled: true
            nri-kube-events:
              enabled: true
            global:
              licenseKey: ${nr-env:NR_LICENSE_KEY}
              cluster: ${nr-env:NR_CLUSTER_NAME}
              nrStaging: ${nr-env:NR_STAGING}
              lowDataMode: ${nr-env:NR_LOW_DATA_MODE}
              verboseLog: ${nr-env:NR_VERBOSE_LOG}
          values.yaml: |
            newrelic-infrastructure: 
              ${nr-var:chart_values.newrelic-infrastructure | indent 2}
            nri-metadata-injection: 
              ${nr-var:chart_values.nri-metadata-injection | indent 2}
            kube-state-metrics: 
              ${nr-var:chart_values.kube-state-metrics | indent 2}
            nri-kube-events: 
              ${nr-var:chart_values.nri-kube-events | indent 2}
            global: 
              ${nr-var:chart_values.global | indent 2}
          fixed.yaml: |
            nri-prometheus:
              enabled: false
            newrelic-logging:
              enabled: false
            newrelic-pixie:
              enabled: false
            k8s-agents-operator:
              enabled: false
            pixie-chart:
              enabled: false
            newrelic-infra-operator:
              enabled: false
            newrelic-prometheus-agent:
              enabled: false
            newrelic-k8s-metrics-adapter:
              enabled: false
      release:
        apiVersion: helm.toolkit.fluxcd.io/v2
        kind: HelmRelease
        metadata:
          name: ${nr-sub:agent_id}
          namespace: ${nr-ac:namespace}
        spec:
          targetNamespace: ${nr-ac:namespace_agents}
          releaseName: ${nr-sub:agent_id}
          interval: 3m
          chart:
            spec:
              chart: ./charts/nri-bundle
              version: ${nr-var:chart_version}
              reconcileStrategy: ChartVersion
              sourceRef:
                kind: GitRepository
                name: ${nr-sub:agent_id}
                namespace: ${nr-ac:namespace}
              interval: 3m
          install:
            disableWait: true
            disableWaitForJobs: true
            disableTakeOwnership: true
            remediation:
              retries: 3
            replace: true
            createNamespace: true
          upgrade:
            disableWait: true
            disableWaitForJobs: true
            disableTakeOwnership: true
            cleanupOnFail: true
            force: true
            remediation:
              retries: 3
              strategy: rollback
          rollback:
            disableWait: true
            disableWaitForJobs: true
          valuesFrom:
            - kind: Secret
              name: values-${nr-sub:agent_id}
              valuesKey: default.yaml
            - kind: Secret
              name: values-${nr-sub:agent_id}
              valuesKey: values.yaml
            - kind: Secret
              name: values-${nr-sub:agent_id}
              valuesKey: fixed.yaml
