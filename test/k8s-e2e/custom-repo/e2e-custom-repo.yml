# This test exercise the use case where a custom local helm repository with basic auth is used for all charts.
# Ensuring any exposed parameter related to this feature is being correctly wired.
description: E2E Test

custom_test_key: cluster_name

scenarios:
  - description: Asserts custom helm chart repo configuration works as expected
    before:
      - cd ../../../ && CHARTMUSEUM_BASIC_AUTH=true SA_CHART_VALUES_FILE="test/k8s-e2e/custom-repo/ac-values-custom-repo.yml" CLUSTER=${SCENARIO_TAG} tilt ci || true
      - kubectl logs -l app.kubernetes.io/name=agent-control --all-containers --prefix=true
      - kubectl logs -l job-name=ac-agent-control-install-job --all-containers --prefix=true
      - kubectl logs -l job-name=ac-agent-control-flux-install-job --all-containers --prefix=true
      - kubectl logs -l job-name=ac-agent-control-generate-system-identity --all-containers --prefix=true
      - kubectl get secrets --show-labels
      - kubectl get pods -o yaml
      - kubectl get all -o wide  --show-labels
      - kubectl get helmrelease
      - kubectl get helmchart
      - helm list -a -A
    after:
      - kubectl logs -l app.kubernetes.io/name=agent-control --all-containers --prefix=true
      - kubectl logs -l app.kubernetes.io/instance=prometheus --all-containers --prefix=true -n newrelic-agents
      - kubectl get secrets --show-labels
      - kubectl get all -o wide
      - kubectl get helmrelease -o yaml
      - kubectl get helmchart -o yaml
      - kubectl get helmrepository -o yaml
      - helm list -a -A
      - cd ../../../ && tilt down
    tests:
      nrqls:
        # Check that prometheus-agent is collecting metrics, an extra where testKey=$SCENARIO_TAG is always added.
        - query: "FROM Metric SELECT * WHERE collector.name = 'prometheus-agent'"
