description: E2E Test

custom_test_key: cluster_name

scenarios:
  - description: Deploy all infra agents
    before:
      - cd ../../ && SA_CHART_VALUES_FILE="test/k8s-e2e/super-agent-infra.yml" CLUSTER=${SCENARIO_TAG} tilt ci
      - sleep 60
    after:
      - kubectl logs -l app.kubernetes.io/name=super-agent-deployment --all-containers --prefix=true
      - kubectl logs -l app.kubernetes.io/instance=infra --all-containers --prefix=true
      - kubectl logs -l app.kubernetes.io/instance=prometheus --all-containers --prefix=true
      - kubectl logs -l app.kubernetes.io/name=newrelic-logging --all-containers --prefix=true
      - kubectl get all -o wide
      - cd ../../ && tilt down
    tests:
      nrqls:
        # Check that prometheus-agent is collecting metrics, an extra where testKey=$SCENARIO_TAG is always added.
        - query: "FROM Metric SELECT * WHERE collector.name = 'prometheus-agent'"
        # Check Logs data is reported, an extra where testKey=$SCENARIO_TAG is always added.
        - query: "From Log SELECT *"
        # Check that newrelic-infrastructure data is reported, an extra where testKey=$SCENARIO_TAG is always added.
        - query: "FROM K8sClusterSample SELECT *"
