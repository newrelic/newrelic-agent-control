---
- name: Install Agent Control on a network restricted environment
  hosts: 127.0.0.1
  connection: local
  become: true
  gather_facts: yes

  tasks:
    - name: Cleanup
      include_tasks: ./tasks/clean_all.yaml 

    - name: Install docker
      include_role:
        name: caos.ansible_roles.docker_install 
    
    - name: Run proxy container
      community.docker.docker_container:
        name: "mitmproxy"
        image: "mitmproxy/mitmproxy:12"
        auto_remove: true
        detach: true
        tty: true
        command: mitmweb --web-host 0.0.0.0
        volumes:
          - /tmp/mitmproxy:/home/mitmproxy/.mitmproxy
        ports:
          - "8080:8080"
          - "8081:8081"

    - name: Wait for mitmproxy CA certificate to be generated
      ansible.builtin.wait_for:
        path: /tmp/mitmproxy/mitmproxy-ca.pem
        timeout: 30

    - name: Copy mitmproxy CA certificate to system trust store
      ansible.builtin.copy:
        src: /tmp/mitmproxy/mitmproxy-ca.pem
        dest: /usr/local/share/ca-certificates/mitmproxy-ca.crt
        remote_src: yes

    - name: Update CA certificates
      ansible.builtin.command:
        cmd: update-ca-certificates

    - name: Install UFW
      ansible.builtin.package:
        name: ufw
        state: present

    - name: Backup current UFW rules
      shell: |
        ufw status > /tmp/ufw_status.txt
        cp /etc/ufw/user.rules /tmp/user.rules.backup
        cp /etc/ufw/user6.rules /tmp/user6.rules.backup

    - name: Set firewall rules
      block:
        - name: Deny all outgoing traffic by default
          community.general.ufw:
            policy: deny
            direction: outgoing

        - name: Allow proxy to reach out from docker
          community.general.ufw:
            rule: allow
            direction: out
            interface: docker0

        - name: Enable UFW
          community.general.ufw:
            state: enabled

        - name: Verify UFW rules with bash script
          shell: |
            # Test that direct traffic is blocked
            curl -s --max-time 5 https://www.newrelic.com
            direct=$?
            if [ $direct -eq 0 ]; then
              echo "ERROR: Direct traffic is not blocked"
              exit 1
            fi
            
            # Test that proxied traffic works
            curl -s --max-time 5 --proxy http://localhost:8080 https://www.newrelic.com
            proxy=$?
            if [ $proxy -ne 0 ]; then
              echo "ERROR: Traffic blocked with proxy or proxy not working"
              exit 1
            fi

        - name: Install Agent Control
          environment:
            HTTPS_PROXY: "http://localhost:8080"
            HTTP_PROXY: "http://localhost:8080"
          block:
            - name: Create AC etc dir
              file:
                path: "/etc/newrelic-agent-control/"
                state: directory

            - name: Import the L2 private key from env-var
              copy:
                dest: "/etc/newrelic-agent-control/priv.key"
                # Read private key from an env var directly because of issues passing multiline --extra-vars to ansible-playbook.
                content: "{{ lookup('ansible.builtin.env', 'NR_SYSTEM_IDENTITY_PRIVATE_KEY') }}"
                
            - name: Install Agent Control
              include_role:
                name: install_ac_recipe
              vars:
                ac_proxy_url: "http://localhost:8080"
                monitoring_source: "infra-agent"
                # ac-e2e-host-no-deployment fleet on canaries account
                fleet_id: NjQyNTg2NXxOR0VQfEZMRUVUfDAxOWE5NjY2LTkxYzQtN2M0My1hNzZhLWY0YWVmODE4NWM4NA
                agent_control_private_key: "/etc/newrelic-agent-control/priv.key"
            
            - name: Set test identifier
              set_fact:
                test_id: "onhost-e2e-proxy-{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M-%S') }}"

            - name: Setup AC config
              include_role:
                name: edit_yaml_config
              vars:
                config_path: "/etc/newrelic-agent-control/local-data/agent-control/local_config.yaml"
                update_config:
                  host_id: "{{ test_id }}"
                  log:
                    format:
                      formatter: pretty
                      target: true
                    level: debug
            
            - name: Restart Agent Control
              include_role:
                name: caos.ansible_roles.service_status
              vars:
                service_name: "newrelic-agent-control"
                action: "restart"

            - name: Assert that infra agent is reporting
              include_role:
                name: nrql_api_request
                apply:
                  become: false
              vars:
                nrql_query: >-
                  SELECT *
                  FROM SystemSample
                  WHERE `host.id` = '{{ test_id }}'
                  LIMIT 1
                retries: 120
                delay: 10
          rescue:
            - name: AC logs
              shell: journalctl -u newrelic-agent-control --no-pager
              register: ac_logs
            - name: Debug AC logs
              debug:
                var: ac_logs.stdout_lines
      always:
        - name: Restore firewall rules
          shell: |
            cp /tmp/user.rules.backup /etc/ufw/user.rules
            cp /tmp/user6.rules.backup /etc/ufw/user6.rules
            ufw --force reload
            if grep -q "inactive" /tmp/ufw_status.txt; then
              ufw --force disable
            else
              ufw --force enable
            fi
