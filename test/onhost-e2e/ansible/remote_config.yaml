---
# This test expects to have a created Fleet with an Active deployment containing an infra-agent
# remote configuration containing:
# ```yaml
# config_agent:
#   status_server_enabled: true
#   status_server_port: 18003
#   license_key: '{{NEW_RELIC_LICENSE_KEY}}'
#   custom_attributes:
#     config_origin: remote
#     test_id: '{{TEST_ID}}'
# ```
# Remember to pass `{% raw %}` and `{% endraw %}` to escape the quoting and braces.
# This would make that the infra agent reported metrics contain a `config_origin: remote` attribute.

- name: Install AC and assert a remote config is applied.
  hosts: 127.0.0.1
  connection: local
  become: true
  gather_facts: yes

  tasks:
    - name: Install AC and assert a remote config is applied.
      block:
        - name: Cleanup
          include_tasks: ./tasks/clean_all.yaml

        - name: Create AC etc dir
          file:
            path: "/etc/newrelic-agent-control/"
            state: directory

        - name: Import the L2 private key from env-var
          copy:
            dest: "/etc/newrelic-agent-control/priv.key"
            # Read private key from an env var directly because of issues passing multiline --extra-vars to ansible-playbook.
            content: "{{ lookup('ansible.builtin.env', 'NR_SYSTEM_IDENTITY_PRIVATE_KEY') }}"

        - name: Install Agent Control
          include_role:
            name: install_ac_recipe
          vars:
            monitoring_source: "infra-agent"
            # ac-e2e-onhost-2 fleet on canaries account
            fleet_id: NjQyNTg2NXxOR0VQfEZMRUVUfDAxOTkyOGQyLTg3OTAtNzJlNC05ODgwLTJhYzE0NTRlZDUyZg
            agent_control_private_key: "/etc/newrelic-agent-control/priv.key"

        - name: Setup AC config
          include_role:
            name: edit_yaml_config
          vars:
            config_path: "/etc/newrelic-agent-control/local-data/agent-control/local_config.yaml"
            update_config:
              log:
                format:
                  formatter: pretty
                  target: true
                level: debug

        - name: Set test identifier
          set_fact:
            test_id: "sub_agent_remote_config_{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M-%S') }}"

        - name: Add TEST_ID to service to be used by remote config reference
          shell: echo 'TEST_ID="{{ test_id }}"' >> {{ agent_control_service_conf }}

        - name: Infra Agent config folder
          file:
            path: /etc/newrelic-agent-control/local-data/nr-infra/
            state: directory

        - name: Infra Agent local config
          copy:
            dest: /etc/newrelic-agent-control/local-data/nr-infra/local_config.yaml
            content: |
              {% raw %}
              config_agent:
                status_server_enabled: true
                status_server_port: 18003
                license_key: '{{NEW_RELIC_LICENSE_KEY}}'
                custom_attributes:
                  config_origin: local
                  test_id: '{{TEST_ID}}'
              {% endraw %}

        - name: Restart Agent Control
          include_role:
            name: caos.ansible_roles.service_status
          vars:
            service_name: "newrelic-agent-control"
            action: "restart"

        - name: Assert that the sub-agent is reporting data
          include_role:
            name: nrql_api_request
            apply:
              become: false
          vars:
            nrql_query: >-
              SELECT *
              FROM SystemSample
              WHERE `test_id` = '{{ test_id }}'
              LIMIT 1
            retries: 60
            delay: 5

        # At this point the AC should register to the fleet , and the active deployment should send the remote config

        - name: Assert that remote config has been applied
          include_role:
            name: nrql_api_request
            apply:
              become: false
          vars:
            nrql_query: >-
              SELECT *
              FROM SystemSample
              WHERE `config_origin` = 'remote'
              AND `test_id` = '{{ test_id }}'
              LIMIT 1
            # This was taking about 5m when the test was created
            retries: 120
            delay: 10

      rescue:
        - name: AC logs
          shell: journalctl -u newrelic-agent-control --no-pager
          register: ac_logs

        - name: Debug AC logs
          debug:
            var: ac_logs.stdout_lines

        - name: Inspect the remote values
          shell: cat /var/lib/newrelic-agent-control/fleet-data/nr-infra/remote_config.yaml
          register: remote_values

        - name: Debug remote values
          debug:
            var: remote_values.stdout_lines

        - name: Inspect the rendered config file from remote
          shell: cat /var/lib/newrelic-agent-control/auto-generated/nr-infra/config/newrelic-infra.yaml
          register: rendered_config

        - name: Debug rendered config
          debug:
            var: rendered_config.stdout_lines

        - name: Debug test identifier
          debug:
            var: test_id

    - name: Cleanup
      include_tasks: ./tasks/clean_all.yaml
