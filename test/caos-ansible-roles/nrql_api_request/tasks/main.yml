---

# TODO: Edit the caos_ansible_roles task adding "retries", "delay" and "until" and remove this one.

- name: Execute NRQL
  delegate_to: 127.0.0.1
  uri:
    headers:
      Content-Type: "application/json"
      API-Key: "{{ nr_api_key }}"
    url: "{{ nr_api_host }}/graphql"
    method: POST
    body_format: json
    body:
      query: |
        {
          actor {
            account(id: {{ nr_account_id }}) {
              nrql(query: "{{ nrql_query }}") {
                            results
              }
            }
          }
        }
  register: response
  retries: "{{ retries }}"
  delay: "{{ delay }}"
  until: response.json is defined and
         response.json.data.actor.account.nrql is defined and
         response.json.data.actor.account.nrql.results != []

- name: fail if errors are present
  fail:
    msg: "error executing NRQL: {{ response | community.general.json_query('json.errors[*].message') | join(', ') }}"
  when: "response.json.data.actor.account.nrql.results is undefined"

- set_fact:
    results: "{{ response.json.data.actor.account.nrql.results }}"
