---

- include_tasks: get_agents.yml

- name: Filter agents by provided instance_ids and host and being healthy
  ansible.builtin.debug:
    msg: "{{ response.json | community.general.json_query(server_name_query) }}"
  vars:
    server_name_query: "data.account.agents.results[?contains(`{{ assert_agents_health.instance_ids | to_json }}`, uid) && host.name=='{{assert_agents_health.host}}' && healthy]"
  register: filtered_by_instance_id_healthy
  when: assert_agents_health.healthy

- name: "assert that agents matching expectations is as expected"
  assert:
    that:  filtered_by_instance_id_healthy.msg | length  == assert_agents_health.instance_ids | length
    fail_msg: "Expected agents count to be '{{ assert_agents_health.instance_ids | length }}', but got {{ filtered_by_instance_id_healthy.msg | length }}"
  when: assert_agents_health.healthy

- name: Filter agents by provided instance_ids and host and being unhealthy
  ansible.builtin.debug:
    msg: "{{ response.json | community.general.json_query(server_name_query) }}"
  vars:
    server_name_query: "data.account.agents.results[?contains(`{{ assert_agents_health.instance_ids | to_json }}`, uid) && host.name=='{{assert_agents_health.host}}' && !healthy]"
  register: filtered_by_instance_id_unhealthy
  when: not assert_agents_health.healthy

- name: "assert that agents matching expectations is as expected"
  assert:
    that:  filtered_by_instance_id_unhealthy.msg | length  == assert_agents_health.instance_ids | length
    fail_msg: "Expected agents count to be '{{ assert_agents_health.instance_ids | length }}', but got {{ filtered_by_instance_id_unhealthy.msg | length }}"
  when: not assert_agents_health.healthy

...
