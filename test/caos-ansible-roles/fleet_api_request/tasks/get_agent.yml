---

- name: Fleet API Get Agent
  include_role:
    name: graphql_request
    apply:
      become: false
  vars:
    - graphql_query: |
        {
          account  {
              agent(agentUid: "{{ get_agent.agent_instance_id }}"){
                  accountId
                  type
                  createdAt
                  lastRemoteConfigHash
                  remoteConfigurations {
                      configurationId
                      configurationName
                      revisionNumber
                      content
                      agentType                      
                  }
                  effectiveConfigurations {
                      name
                      content
                      contentType
                  }
                  lastSeen
                  lastError
                  healthy
                  host{
                      name
                  }
              }
          }
        }


- name: fail if errors are present
  fail:
    msg: "error creating configuration revision: {{ response | community.general.json_query('json.errors[*].message') | join(', ') }}"
  when: '"errors" in response.json'

# output facts
- name: set agent
  ansible.builtin.set_fact: {"{{ get_agent.agent_fact }}": "{{ response | community.general.json_query(query) }}"}
  vars:
    query: "json.data.account.agent"


...
