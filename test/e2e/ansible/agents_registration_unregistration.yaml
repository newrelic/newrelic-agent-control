---
- name: Agents registration/unregistration
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes

  tasks:
    - name: Fresh Super Agent installation with InfraAgent and NRDOT
      include_tasks: ./tasks/fresh_super_agent_installation_{{ ansible_system }}.yaml

    - name: Setup NR Super Agent config without any agent
      include_role:
        name: edit_yaml_config
      vars:
        config_path: "/etc/newrelic-super-agent/config.yaml"
        update_config:
          agents: {}

    - name: Restart New Relic Super Agent
      ansible.builtin.service:
        name: newrelic-super-agent
        state: restarted

    - name: Wait for 60 seconds so the agents are unregistered on the Fleet
      pause:
        seconds: 60

    - name: Assert SubAgents are not running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_not_running:
          - "^/usr/bin/newrelic-infra"
          - "^/usr/bin/nr-otel-collector"

    - name: Assert super-agent is healthy
      include_role:
        name: fleet_api_request
      vars:
        assert_agents_health:
          instance_ids: [ "{{ super_agent_instance_id }}" ]
          host: "{{ hostname }}"
          healthy: true
