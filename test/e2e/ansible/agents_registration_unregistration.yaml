---
- name: Agents registration/unregistration
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes

  tasks:
    - name: Fresh Super Agent installation with InfraAgent and NRDOT
      include_tasks: ./tasks/fresh_super_agent_installation_{{ ansible_system }}.yaml
      vars:
        infra_agent_type_version: "0.1.2"
        otel_agent_type_version: "0.1.0"

    - name: Get NR Super Agent InstanceID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/identifiers.yaml"
        identifier_field: "instance_id"
        identifier_field_fact: "super_agent_instance_id"

    - name: Get Infra agent InstanceID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-infra-agent/identifiers.yaml"
        identifier_field: "instance_id"
        identifier_field_fact: "infra_agent_instance_id"

    - name: Get NR Otel Collector InstanceID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-otel-collector/identifiers.yaml"
        identifier_field: "instance_id"
        identifier_field_fact: "otel_agent_instance_id"

    - name: Get Hostname
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/identifiers.yaml"
        identifier_field: "hostname"
        identifier_field_fact: "hostname"

    - name: Setup NR Super Agent config without any agent
      include_role:
        name: super-agent-config
      vars:
        empty_agents: true

    - name: Restart New Relic Super Agent
      ansible.builtin.service:
        name: newrelic-super-agent
        state: restarted

    - name: Wait for 60 seconds so the agents are unregistered on the Fleet
      pause:
        seconds: 60

    - name: Assert SubAgents are not running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_not_running:
          - "^/usr/bin/newrelic-infra"
          - "^/usr/bin/nr-otel-collector"

    - name: Assert super-agent is healthy
      include_role:
        name: fleet_api_request
      vars:
        assert_agents_health:
          instance_ids: [ "{{ super_agent_instance_id }}" ]
          host: "{{ hostname }}"
          healthy: true
