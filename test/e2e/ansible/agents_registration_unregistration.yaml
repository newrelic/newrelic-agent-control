---
- name: test configuration
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes

  tasks:
    - name: Fresh Super Agent installation with InfraAgent and NRDOT
      include_tasks: ./tasks/fresh_super_agent_installation_{{ ansible_system }}.yaml
      vars:
        infra_agent_type_version: "0.1.0"

    - name: Get NR Super Agent ULID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/identifiers.yaml"
        identifier_field: "ulid"
        identifier_field_fact: "super_agent_ulid"

    - name: Get Infra agent ULID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-infra-agent/identifiers.yaml"
        identifier_field: "ulid"
        identifier_field_fact: "infra_agent_ulid"

    - name: Get NR Otel Collector ULID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-otel-collector/identifiers.yaml"
        identifier_field: "ulid"
        identifier_field_fact: "otel_agent_ulid"

    - name: Get Hostname
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "/var/lib/newrelic-super-agent/identifiers.yaml"
        identifier_field: "hostname"
        identifier_field_fact: "hostname"

    - name: Setup NR Super Agent config without any agent
      include_role:
        name: super-agent-config
      vars:
        empty_agents: true

    - name: Restart New Relic Super Agent
      ansible.builtin.service:
        name: newrelic-super-agent
        state: restarted

    - name: Wait for 60 seconds so the agents are unregistered on the Fleet
      pause:
        seconds: 60

    - name: Assert agents are unhealthy
      include_role:
        name: fleet_api_request
      vars:
        assert_agents_health:
          ulids: ["{{ infra_agent_ulid }}", "{{ otel_agent_ulid }}"]
          host: "{{ hostname }}"
          healthy: false

    - name: Assert super-agent is healthy
      include_role:
        name: fleet_api_request
      vars:
        assert_agents_health:
          ulids: ["{{ super_agent_ulid }}"]
          host: "{{ hostname }}"
          healthy: true
