---
- name: Agents registration/unregistration
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes

  tasks:
    - name: Fresh Agent Control installation with InfraAgent and NRDOT and Host monitoring NR
      include_tasks: ./tasks/fresh_sa_install_host_monitor_nr_{{ ansible_system }}.yaml

    - name: Setup NR Agent Control config without any agent
      include_role:
        name: edit_yaml_config
      vars:
        config_path: "/etc/newrelic-agent-control/config.yaml"
        update_config:
          agents: {}

    - name: Restart New Relic Agent Control
      ansible.builtin.service:
        name: newrelic-agent-control
        state: restarted

    - name: Wait for 60 seconds so the agents are unregistered on the Fleet
      pause:
        seconds: 60

    - name: Assert SubAgents are not running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_not_running:
          - "^/usr/bin/newrelic-infra"
          - "^/usr/bin/nr-otel-collector"

    - name: Assert agent-control is healthy
      include_role:
        name: fleet_api_request
      vars:
        assert_agents_health:
          instance_ids: [ "{{ agent_control_instance_id }}" ]
          host: "{{ hostname }}"
          healthy: true
