---

- name: Sub Agents invalid remote config
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes

  tasks:

    - name: Fresh Super Agent installation
      include_tasks: ./tasks/fresh_super_agent_installation_{{ ansible_system }}.yaml
      vars:
        infra_agent_type_version: "0.1.2"
        otel_agent_type_version: "0.1.0"

    - name: Assert Super Agent and Agents are running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_running:
          - "^/usr/bin/newrelic-super-agent"
          - "^/usr/bin/newrelic-infra"
          - "^/usr/bin/nr-otel-collector"

    - name: set remote config name
      set_fact:
        remote_config_name: "caos-e2e-invalid-sub-agent-config-{{ ansible_date_time.iso8601_micro | to_uuid }}"

    - name: create remote configuration
      include_role:
        name: fleet_api_request
      vars:
        create_remote_configuration:
          account_id: "{{ nr_account_id | int }}"
          config_name: "{{ remote_config_name }}"
          config_id_fact: "created_config_id"

    - name: create invalid YAML config for the infra agent
      include_role:
        name: fleet_api_request
      vars:
        create_remote_configuration_revision:
          account_id: "{{ nr_account_id | int }}"
          config_id: "{{ created_config_id }}"
          content: 'this:is_invalid_yaml'
          config_revision_fact: "created_config_revision"

    - name: get fleet guid for Super Agent
      include_tasks: ./tasks/fleet_guid_by_agent_type.yaml
      vars:
        fleet_guid_fact: fleet_guid
        agent_type: "NEWRELIC_INFRA"

    - name: deploy config to fleet
      include_role:
        name: fleet_api_request
      vars:
        deploy_config_to_fleet:
          account_id: "{{ nr_account_id | int }}"
          fleet_guid: "{{ fleet_guid }}"
          config_id: "{{ created_config_id | int }}"
          config_revision: "{{ created_config_revision | int }}"

    - name: get the infra agent pid
      include_tasks: ./tasks/process_pid_{{ ansible_system }}.yaml
      vars:
        command_line: "/usr/bin/newrelic-infra --config.*"
        process_pid_fact: process_pid

    - name: Get Infra Agent InstanceID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "{{ sub_agent_identifiers_file_tpl | replace('AGENT_ID','nr-infra-agent') }}"
        identifier_field: "instance_id"
        identifier_field_fact: "infra_agent_instance_id"

    - name: authorize Infra Agent
      include_role:
        name: fleet_api_request
      vars:
        authorize_agent:
          account_id: "{{ nr_account_id | int }}"
          agent_instance_id: "{{ infra_agent_instance_id }}"

    - name: Wait for a few seconds for the config to be retrieved
      ansible.builtin.pause:
        seconds: 20

    - name: Check for sub agent remote config
      stat:
        path: "{{ sub_agent_remote_config_file_tpl | replace('AGENT_ID','nr-infra-agent') }}"
      register: result

    - name: Assert that the config was not retrieved
      assert:
        that: not result.stat.exists

    - name: get latest logs from the Super Agent
      shell: journalctl -u newrelic-super-agent --since "1min ago" | grep "error processing remote config"
      register: journalctl_log

    - name: assert the incorrect config was logged
      assert:
        that: "journalctl_log.stdout is search ('sub agent values error: .invalid agent values format: .invalid type: string \"this:is_invalid_yaml\", expected a map..')"

    - name: assert the infra agent is running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_running:
          - "^/usr/bin/newrelic-infra"

    - name: get the infra agent pid
      include_tasks: ./tasks/process_pid_{{ ansible_system }}.yaml
      vars:
        command_line: "/usr/bin/newrelic-infra --config.*"
        process_pid_fact: new_process_pid

    - name: assert the previous and current pid are the same
      assert:
        that: "{{ new_process_pid == process_pid }}"

...
