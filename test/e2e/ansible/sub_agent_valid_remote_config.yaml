---
- name: Sub Agent valid remote config
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes
  no_log: false

  tasks:
    - name: Fresh Super Agent installation with InfraAgent and NRDOT and Host monitoring NR
      include_tasks: ./tasks/fresh_sa_install_host_monitor_nr_{{ ansible_system }}.yaml

    # Ensure Restarting doesn't create new instance_ids
    - name: Restart New Relic Super Agent
      ansible.builtin.service:
        name: newrelic-super-agent
        state: restarted

    - name: Wait for a few seconds to ensure InstanceID recreation process skipped
      ansible.builtin.pause:
        seconds: 30

    - name: Assert Super Agent and Agents are running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_running:
          - "^/usr/bin/newrelic-super-agent"
          - "^/usr/bin/newrelic-infra"
          - "^/usr/bin/nr-otel-collector"

    - name: Get Infra agent InstanceID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "{{ sub_agent_identifiers_file_tpl | replace('AGENT_ID','nr-infra-agent') }}"
        identifier_field: "instance_id"
        identifier_field_fact: "infra_agent_instance_id_restart"

    - name: assert the persisted Infra agent InstanceID is the same
      assert:
        that: "{{ infra_agent_instance_id_restart == infra_agent_instance_id }}"
    # End Ensure

    # Create Fleet
    - name: create fleet
      include_role:
        name: fleet_api_request
      vars:
        create_fleet:
          account_id: "{{ nr_account_id | int }}"
          name: "{{ e2e_run_name }}"
          entity_type: "HOST"
          fleet_guid_fact: "fleet_guid"

    - name: set remote config name
      set_fact:
        remote_config_name: "caos-automated-test-sub-agent-config-{{ ansible_date_time.iso8601_micro | to_uuid }}" # rename this in all playbooks

    - name: set display_name
      set_fact:
        generated_display_name: "caos-{{ ansible_date_time.iso8601_micro | to_uuid }}" # rename this in all playbooks

    - name: create remote configuration for newrelic-infra
      include_role:
        name: fleet_api_request
      vars:
        create_remote_configuration:
          account_id: "{{ nr_account_id | int }}"
          config_name: "{{ remote_config_name }}"
          agent_type: "NR_InfraAgent"
          config_type: "NR_InfraAgentPrimary"
          config_id_fact: "created_config_id"

    - name: create remote configuration revision for created configuration
      include_role:
        name: fleet_api_request
      vars:
        create_remote_configuration_revision:
          account_id: "{{ nr_account_id | int }}"
          config_id: "{{ created_config_id }}"
          # multiline config breaks graphql request
          content: 'config_agent: |\n  staging: true\n  license_key: {{ nr_license_key }}\n  display_name: {{ generated_display_name }}'
          config_revision_fact: "created_config_revision"

    - name: register array of configurations to deploy
      ansible.builtin.set_fact: {"configurations": [{"revision_number":"{{ created_config_revision | int }}", "configuration_id":"{{ created_config_id | int }}" }]}

    - name: deploy fleet add entity and configurations
      include_role:
        name: fleet_api_request
      vars:
        deploy_fleet:
          account_id: "{{ nr_account_id | int }}"
          fleet_guid: "{{ fleet_guid }}"
          name: "{{ e2e_run_name }}"
          configurations: "{{ configurations }}"
          add_entity_guid: "{{ host_entity_guid }}"

    - name: get the infra agent pid
      include_tasks: ./tasks/process_pid_{{ ansible_system }}.yaml
      vars:
        command_line: "/usr/bin/newrelic-infra --config.*"
        process_pid_fact: process_pid

    - name: Wait for a few seconds for the config to be present
      stat:
        path: "{{ sub_agent_remote_config_folder }}/nr-infra-agent/values/values.yaml"
      register: result
      until: result.stat.exists
      retries: 5
      delay: 5

    - name: Pause for 40 seconds to let config be updated
      ansible.builtin.pause:
        seconds: 40

    - name: assert on config content
      include_tasks: ./tasks/assert_full_file_content.yaml
      vars:
        file_path: "{{ sub_agent_remote_config_folder }}/nr-infra-agent/values/values.yaml"
        expected_content: "config_agent: |-\n  staging: true\n  license_key: {{ nr_license_key }}\n  display_name: {{ generated_display_name }}"

    - name: assert on generated config content
      include_tasks: ./tasks/assert_full_file_content.yaml
      vars:
        file_path: "{{ sub_agent_generated_config_folder }}/nr-infra-agent/newrelic-infra.yml"
        expected_content: "staging: true\nlicense_key: {{ nr_license_key }}\ndisplay_name: {{ generated_display_name }}"

    - name: assert the infra agent is running
      include_role:
        name: caos.ansible_roles.assert_process_running
      vars:
        processes_running:
          - "^/usr/bin/newrelic-infra"

    - name: get the infra agent pid
      include_tasks: ./tasks/process_pid_{{ ansible_system }}.yaml
      vars:
        command_line: "/usr/bin/newrelic-infra --config.*"
        process_pid_fact: new_process_pid

    - name: assert the previous and current pid are different
      assert:
        that: "{{ new_process_pid != process_pid }}"

    - name: Get Infra agent InstanceID
      include_tasks: ./tasks/get_identifier_field_{{ ansible_system }}.yaml
      vars:
        agent_identifier_path: "{{ sub_agent_identifiers_file_tpl | replace('AGENT_ID','nr-infra-agent') }}"
        identifier_field: "instance_id"
        identifier_field_fact: "infra_agent_instance_id_new_config"

    - name: assert the persisted Infra agent InstanceID is the same
      assert:
        that: "{{ infra_agent_instance_id_restart == infra_agent_instance_id_new_config }}"

    - name: delete the fleet
      include_tasks: ./tasks/clean_fleet.yaml
      vars:
        clean_account_id: "{{ nr_account_id | int }}"
        clean_fleet_guid: "{{ fleet_guid }}"
        clean_name: "{{ e2e_run_name }}"
        clean_entity_guid: "{{ host_entity_guid }}"
