---
- name: Get metrics sent by nri-mysql
  include_role:
    name: caos.ansible_roles.nrql_api_request
    apply:
      become: false
  vars:
    nrql_query: >-
      SELECT latest(`mysql.node.openTables`) AS openTables
      FROM Metric
      WHERE host.hostname = '{{ ansible_hostname }}' AND test_id = '{{ test_id }}' AND app = '{{ app }}'
      SINCE 30 SECONDS AGO

- name: Assert that nri-mysql is sending data
  assert:
    that:
      - results[0]["openTables"] is not none
    success_msg: "nri-mysql is sending data, as expected"
