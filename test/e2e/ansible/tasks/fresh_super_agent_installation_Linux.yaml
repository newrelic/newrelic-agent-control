---
- name: Cleanup
  include_tasks: ./clean_all.yaml

- name: Installation
  include_tasks: ./install.yaml

- name: Setup Infra Agent config
  include_role:
    name: infra-agent-config

- name: Setup NR Otel Collector config
  include_role:
    name: nr-otel-collector-config

- name: Setup NR Super Agent config
  include_role:
    name: super-agent-config

- name: Restart New Relic Super Agent
  ansible.builtin.service:
    name: newrelic-super-agent
    state: restarted

- name: Get Hostname
  include_tasks: ./get_identifier_field_{{ ansible_system }}.yaml
  vars:
    agent_identifier_path: "{{ super_agent_identifiers_file }}"
    identifier_field: "hostname"
    identifier_field_fact: "hostname"

- name: Get NR Super Agent InstanceID
  include_tasks: ./get_identifier_field_{{ ansible_system }}.yaml
  vars:
    agent_identifier_path: "{{ super_agent_identifiers_file }}"
    identifier_field: "instance_id"
    identifier_field_fact: "super_agent_instance_id"

- name: Get Infra agent InstanceID
  include_tasks: ./get_identifier_field_{{ ansible_system }}.yaml
  vars:
    agent_identifier_path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-infra-agent/identifiers.yaml"
    identifier_field: "instance_id"
    identifier_field_fact: "infra_agent_instance_id"

- name: Get NR Otel Collector InstanceID
  include_tasks: ./get_identifier_field_{{ ansible_system }}.yaml
  vars:
    agent_identifier_path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-otel-collector/identifiers.yaml"
    identifier_field: "instance_id"
    identifier_field_fact: "otel_agent_instance_id"

- name: Wait for 60 seconds so the agents are registered on the Fleet
  pause:
    seconds: 60

- name: Assert agents exist and are healthy
  include_role:
    name: fleet_api_request
  vars:
    assert_agents_health:
      instance_ids: [ "{{ infra_agent_instance_id }}", "{{ otel_agent_instance_id }}", "{{ super_agent_instance_id }}" ]
      host: "{{ hostname }}"
      healthy: true

- name: Check infra-agent values file doesn't exist
  stat:
    path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-infra-agent/values/values.yaml"
  register: infra_agent_values

- name: Check otel-collector values file doesn't exist
  stat:
    path: "/var/lib/newrelic-super-agent/fleet/agents.d/nr-otel-collector/values/values.yaml"
  register: otel_collector_values

- name: Check super-agent values file doesn't exist
  stat:
    path: "/var/lib/newrelic-super-agent/fleet/values/values.yaml"
  register: super_agent_values

- name: ensure values files don't exist
  assert:
    that: "not super_agent_values.stat.exists and not otel_collector_values.stat.exists and not infra_agent_values.stat.exists"
