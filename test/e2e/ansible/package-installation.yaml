---
- name: Validate repository with package installation and print Agent Control version
  hosts: testing_hosts_linux
  become: true
  gather_facts: yes

  tasks:
    - name: Cleanup
      include_tasks: ./tasks/clean_all.yaml

    - name: Install nightly Agent Control
      include_role:
        name: newrelic-agent-control

    - name: register agent control version
      command: "/usr/bin/newrelic-agent-control --version"
      register: version

    - name: assert version
      include_role:
        name: caos.ansible_roles.assert_version
      vars:
        target_versions:
          - exec: "/usr/bin/newrelic-agent-control --version"
            version: "{{ package_version }}"
      when: package_version | length > 0

    - name: debug agent control version
      debug:
        var: version.stdout

    - name: Cleanup
      include_tasks: ./tasks/clean_all.yaml
